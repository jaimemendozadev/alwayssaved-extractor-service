name: Deploy Notecasts Extractor Service

on:
  workflow_dispatch:  # ✅ Manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH for GitHub Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/notecasts-key.pem
          chmod 600 ~/.ssh/notecasts-key.pem
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/notecasts-key.pem
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Deploy Extractor Service to EC2
        run: |
          ssh -i ~/.ssh/notecasts-key.pem -o IdentitiesOnly=yes -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          # ✅ Switch to the home directory to ensure a clean start
          cd /home/ec2-user

          # ✅ Set proper permissions for environment
          export PATH="\$HOME/.local/bin:\$PATH"
          export SHELL=/bin/bash

          # ✅ Install dependencies if missing
          sudo yum update -y
          sudo yum install -y git ffmpeg python3 python3-pip

          # ✅ Ensure Pipenv is installed
          python3 -m pip install --user pipenv
          export PATH="\$HOME/.local/bin:\$PATH"

          # ✅ Create project directory if it doesn’t exist
          mkdir -p notecasts-extractor-service
          cd notecasts-extractor-service

          # ✅ Verify Git is installed
          which git || echo "❌ Git is missing!"

          # ✅ Clone repo if not present, otherwise pull latest changes
          if [ ! -d ".git" ]; then
            git clone https://github.com/jaimemendozadev/notecasts-extractor-service.git .
          else
            git pull origin main
          fi

          # ✅ Install dependencies
          pipenv install

          # ✅ Start the service in the background
          nohup pipenv run python service.py > output.log 2>&1 &
          EOF
